# .github/workflows/dependencies.yml
# Surveillance automatique des dÃ©pendances et sÃ©curitÃ©

name: ðŸ“¦ Dependencies & Security Monitor

on:
  schedule:
    - cron: "0 6 * * 1" # Tous les lundis Ã  6h UTC
    - cron: "0 18 * * 5" # Tous les vendredis Ã  18h UTC
  push:
    branches: [main, develop]
    paths:
      - "**/package.json"
      - "pnpm-lock.yaml"
  pull_request:
    branches: [main]
    paths:
      - "**/package.json"
      - "pnpm-lock.yaml"
  workflow_dispatch:
    inputs:
      create_pr:
        description: "Create PR for updates"
        required: false
        default: "false"
        type: boolean
permissions:
  contents: read
  issues: write
  pull-requests: write

env:
  NODE_VERSION: "22.14.0"
  PNPM_VERSION: "10.13.1"

jobs:
  # ðŸ” Audit de sÃ©curitÃ© avancÃ©
  security-audit:
    name: ðŸ›¡ï¸ Advanced Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” pnpm security audit
        run: |
          echo "ðŸ” Running pnpm security audit..."
          pnpm audit --audit-level moderate --json > pnpm-audit.json || true

          # Afficher le rÃ©sumÃ©
          if [ -s pnpm-audit.json ]; then
            echo "âš ï¸ Vulnerabilities found in pnpm audit"
            cat pnpm-audit.json | jq '.metadata.vulnerabilities' || echo "No detailed vulnerability info"
          else
            echo "âœ… No vulnerabilities found in pnpm audit"
          fi

      - name: ðŸ” audit-ci strict check
        run: |
          echo "ðŸ” Running audit-ci strict check..."
          pnpm dlx audit-ci --config audit-ci.json

      - name: ðŸ” Check for unused dependencies
        run: |
          echo "ðŸ” Checking for unused dependencies..."
          pnpm dlx depcheck --json > depcheck-results.json || true

          # Analyser les rÃ©sultats
          if [ -s depcheck-results.json ]; then
            echo "ðŸ“Š Depcheck results:"
            cat depcheck-results.json | jq '.dependencies // empty' || echo "No unused dependencies"
          fi

      - name: ðŸ”Ž Snyk Security Scan
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --all-projects --severity-threshold=medium --json > snyk-results.json

      - name: ðŸ“¤ Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            pnpm-audit.json
            depcheck-results.json
            snyk-results.json
          retention-days: 30

  # ðŸ“Š Analyse des dÃ©pendances obsolÃ¨tes
  outdated-analysis:
    name: ðŸ“Š Outdated Dependencies Analysis
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ“Š Check outdated packages
        run: |
          echo "ðŸ“Š Checking for outdated packages..."
          pnpm outdated --recursive --format list > outdated-packages.txt || true

          if [ -s outdated-packages.txt ]; then
            echo "ðŸ“¦ Outdated packages found:"
            cat outdated-packages.txt
            echo "outdated_found=true" >> $GITHUB_ENV
          else
            echo "âœ… All packages are up to date"
            echo "outdated_found=false" >> $GITHUB_ENV
          fi

      - name: ðŸ” Detailed dependency analysis
        run: |
          echo "ðŸ” Running detailed dependency analysis..."

          # Analyser les vulnÃ©rabilitÃ©s par niveau de sÃ©vÃ©ritÃ©
          echo "## ðŸ“Š Dependency Analysis Report" > dependency-report.md
          echo "Generated on: $(date)" >> dependency-report.md
          echo "" >> dependency-report.md

          # Packages outdated
          if [ -s outdated-packages.txt ]; then
            echo "### ðŸ“¦ Outdated Packages" >> dependency-report.md
            echo "\`\`\`" >> dependency-report.md
            cat outdated-packages.txt >> dependency-report.md
            echo "\`\`\`" >> dependency-report.md
          else
            echo "### âœ… All packages up to date" >> dependency-report.md
          fi

      - name: ðŸŽ¯ npm-check-updates analysis
        run: |
          echo "ðŸŽ¯ Running npm-check-updates analysis..."
          npx npm-check-updates --format group --target minor > ncu-analysis.txt || true

          if [ -s ncu-analysis.txt ]; then
            echo "" >> dependency-report.md
            echo "### ðŸŽ¯ NCU Analysis (Minor Updates)" >> dependency-report.md
            echo "\`\`\`" >> dependency-report.md
            cat ncu-analysis.txt >> dependency-report.md
            echo "\`\`\`" >> dependency-report.md
          fi

      - name: ðŸ“¤ Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: |
            outdated-packages.txt
            ncu-analysis.txt
            dependency-report.md
          retention-days: 30

      - name: ðŸš¨ Create issue if critical updates needed
        if: env.outdated_found == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let reportContent = "# ðŸ“¦ Weekly Dependencies Report\n\n";
            reportContent += "Des dÃ©pendances obsolÃ¨tes ont Ã©tÃ© dÃ©tectÃ©es.\n\n";

            try {
              const outdated = fs.readFileSync('outdated-packages.txt', 'utf8');
              reportContent += "## ðŸ“Š Packages obsolÃ¨tes\n\n";
              reportContent += "```\n" + outdated + "\n```\n\n";
            } catch (e) {
              console.log('No outdated packages file found');
            }

            reportContent += "## ðŸŽ¯ Actions recommandÃ©es\n\n";
            reportContent += "1. VÃ©rifier les breaking changes des nouvelles versions\n";
            reportContent += "2. ExÃ©cuter `pnpm update --latest` pour les mises Ã  jour mineures\n";
            reportContent += "3. Tester en local avant de merger\n";
            reportContent += "4. Planifier les mises Ã  jour majeures\n\n";
            reportContent += "---\n";
            reportContent += "GÃ©nÃ©rÃ© automatiquement par GitHub Actions";

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ“¦ Dependencies Update Required - ${new Date().toISOString().split('T')[0]}`,
              body: reportContent,
              labels: ['dependencies', 'maintenance', 'automated']
            });

  # ðŸ”„ Mise Ã  jour automatique (optionnelle)
  auto-update:
    name: ðŸ”„ Auto Update Dependencies
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.create_pr == 'true' || (github.event_name == 'schedule' && github.ref == 'refs/heads/develop') }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ðŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”„ Update patch and minor versions
        run: |
          echo "ðŸ”„ Updating patch and minor versions..."

          # Sauvegarder l'Ã©tat actuel
          cp pnpm-lock.yaml pnpm-lock.yaml.backup

          # Mettre Ã  jour les versions patch/minor
          pnpm update --latest

          # VÃ©rifier s'il y a des changements
          if ! git diff --quiet pnpm-lock.yaml; then
            echo "changes_detected=true" >> $GITHUB_ENV
            echo "âœ… Dependencies updated"
          else
            echo "changes_detected=false" >> $GITHUB_ENV
            echo "â„¹ï¸ No updates available"
          fi

      - name: ðŸ§ª Run quick validation
        if: env.changes_detected == 'true'
        run: |
          echo "ðŸ§ª Running quick validation after updates..."

          # Tests rapides pour valider les mises Ã  jour
          pnpm install
          pnpm type-check || exit 1
          pnpm audit --audit-level moderate || exit 1

          echo "âœ… Quick validation passed"

      - name: ðŸ“ Create Pull Request
        if: env.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ðŸ”„ chore: auto-update dependencies

            - Updated patch and minor versions
            - All security audits passing
            - Quick validation completed
          title: "ðŸ”„ Auto-update dependencies"
          body: |
            ## ðŸ“¦ Automatic Dependencies Update

            Cette PR contient les mises Ã  jour automatiques des dÃ©pendances :

            ### âœ… Validations effectuÃ©es
            - [x] Type checking
            - [x] Security audit
            - [x] Basic functionality tests

            ### ðŸŽ¯ Actions recommandÃ©es
            - [ ] VÃ©rifier les changements manuellement
            - [ ] ExÃ©cuter la suite de tests complÃ¨te
            - [ ] Tester en local si nÃ©cessaire

            ---
            ðŸ¤– GÃ©nÃ©rÃ©e automatiquement par GitHub Actions
          branch: auto-update/dependencies
          labels: |
            dependencies
            automated
            maintenance

  # ðŸ“Š Rapport hebdomadaire
  weekly-report:
    name: ðŸ“Š Weekly Security Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    needs: [security-audit, outdated-analysis]

    steps:
      - name: ðŸ“¥ Download reports
        uses: actions/download-artifact@v5
        with:
          pattern: "*-reports"
          merge-multiple: true

      - name: ðŸ“Š Generate weekly summary
        run: |
          echo "# ðŸ“Š Weekly Security & Dependencies Report" > weekly-report.md
          echo "Generated on: $(date)" >> weekly-report.md
          echo "" >> weekly-report.md

          echo "## ðŸ›¡ï¸ Security Status" >> weekly-report.md
          if [ -f pnpm-audit.json ] && [ -s pnpm-audit.json ]; then
            echo "âš ï¸ Some security issues detected" >> weekly-report.md
          else
            echo "âœ… No security vulnerabilities found" >> weekly-report.md
          fi

          echo "" >> weekly-report.md
          echo "## ðŸ“¦ Dependencies Status" >> weekly-report.md
          if [ -f outdated-packages.txt ] && [ -s outdated-packages.txt ]; then
            echo "ðŸ“Š Some packages need updates" >> weekly-report.md
          else
            echo "âœ… All dependencies up to date" >> weekly-report.md
          fi

          echo "" >> weekly-report.md
          echo "---" >> weekly-report.md
          echo "ðŸ¤– Automated report by TopSteel CI/CD" >> weekly-report.md

      - name: ðŸ“¤ Upload weekly report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-security-report
          path: weekly-report.md
          retention-days: 90
