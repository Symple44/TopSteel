# .github/workflows/pr-checks.yml
name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_OPTIONS: '--max-old-space-size=8192'
  FORCE_COLOR: '1'
  NPM_CONFIG_COLOR: 'always'

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  # VÃ©rification de la taille de la PR
  pr-size:
    name: Check PR Size
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;

            let label = '';
            if (total < 10) label = 'size/XS';
            else if (total < 50) label = 'size/S';
            else if (total < 200) label = 'size/M';
            else if (total < 500) label = 'size/L';
            else label = 'size/XL';

            // Ajouter le label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [label]
            });

            // Avertir si la PR est trop grande
            if (total > 500) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: 'âš ï¸ Cette PR contient plus de 500 lignes de changements. ConsidÃ©rez la diviser en PRs plus petites pour faciliter la review.'
              });
            }

  # Auto-labeling basÃ© sur les fichiers modifiÃ©s
  auto-label:
    name: Auto Label
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/pr-labeler.yml

  # VÃ©rification des commits conventionnels
  commitlint:
    name: Lint Commits
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commits
        uses: wagoid/commitlint-github-action@v6
        with:
          configFile: commitlint.config.js

  # VÃ©rification des traductions i18n
  i18n-check:
    name: Check i18n Translations
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check i18n usage (missing keys)
        run: pnpm --filter @erp/web i18n:usage

      - name: Validate i18n translations
        run: pnpm --filter @erp/web i18n:validate
        continue-on-error: true

      - name: Generate i18n types (verify up-to-date)
        run: |
          pnpm --filter @erp/web i18n:types
          git diff --exit-code apps/web/src/lib/i18n/generated-types.ts || (echo "âŒ i18n types are outdated. Run 'pnpm --filter @erp/web i18n:types'" && exit 1)

  # Analyse des fichiers modifiÃ©s
  changed-files:
    name: Analyze Changed Files
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      web: ${{ steps.changes.outputs.web }}
      api: ${{ steps.changes.outputs.api }}
      packages: ${{ steps.changes.outputs.packages }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            web:
              - 'apps/web/**'
            api:
              - 'apps/api/**'
            packages:
              - 'packages/**'

      - name: Comment changed areas
        uses: actions/github-script@v7
        with:
          script: |
            const changes = {
              web: ${{ steps.changes.outputs.web }},
              api: ${{ steps.changes.outputs.api }},
              packages: ${{ steps.changes.outputs.packages }}
            };

            const affected = Object.entries(changes)
              .filter(([_, changed]) => changed === 'true')
              .map(([area, _]) => area);

            if (affected.length > 0) {
              const body = `ðŸ“¦ **Zones affectÃ©es**: ${affected.join(', ')}`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
